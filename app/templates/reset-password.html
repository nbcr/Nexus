{% extends "base.html" %}

{% block title %}Reset Password - Nexus{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/auth.css?v=202512060200">
{% endblock %}

{% block body_class %}reset-password-page{% endblock %}

{% block content %}
<div class="login-container">
    <h2>Create New Password</h2>
    <form id="reset-password-form">
        <div class="form-row form-row-inline form-row-align">
            <label for="new-password">New Password</label>
            <input type="password" id="new-password" name="new_password" required minlength="8" placeholder="At least 8 characters">
        </div>
        <div class="form-row form-row-inline form-row-align">
            <label for="confirm-password">Confirm Password</label>
            <input type="password" id="confirm-password" name="confirm_password" required minlength="8">
        </div>
        <div id="reset-password-error" class="login-error"></div>
        <div class="login-btn-row">
            <button type="submit" class="login-btn">Reset Password</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Extract token from URL
function getResetToken() {
    const params = new URLSearchParams(globalThis.location.search);
    return params.get('token');
}

document.addEventListener('DOMContentLoaded', function() {
    const token = getResetToken();
    if (!token) {
        const errorDiv = document.getElementById('reset-password-error');
        errorDiv.textContent = 'Invalid or missing reset token. Please request a new password reset link.';
        errorDiv.style.display = 'block';
        document.getElementById('reset-password-form').style.display = 'none';
        return;
    }

    const form = document.getElementById('reset-password-form');
    const errorDiv = document.getElementById('reset-password-error');
    const newPasswordInput = document.getElementById('new-password');
    const confirmPasswordInput = document.getElementById('confirm-password');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        // Clear previous messages
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
        newPasswordInput.classList.remove('flash-error', 'flash-success');
        confirmPasswordInput.classList.remove('flash-error', 'flash-success');
        
        // Validate passwords match
        if (newPassword !== confirmPassword) {
            newPasswordInput.classList.add('flash-error');
            confirmPasswordInput.classList.add('flash-error');
            errorDiv.textContent = 'Passwords do not match.';
            errorDiv.style.display = 'block';
            return;
        }
        
        // Validate password length
        if (newPassword.length < 8) {
            newPasswordInput.classList.add('flash-error');
            errorDiv.textContent = 'Password must be at least 8 characters.';
            errorDiv.style.display = 'block';
            return;
        }
        
        try {
            const response = await fetch('/api/v1/auth/reset-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    token: token,
                    new_password: newPassword 
                })
            });
            
            if (response.ok) {
                newPasswordInput.classList.add('flash-success');
                confirmPasswordInput.classList.add('flash-success');
                errorDiv.innerHTML = '<strong>Password reset successful!</strong> Redirecting to login...';
                errorDiv.style.display = 'block';
                errorDiv.style.color = '#58a6ff';
                
                setTimeout(() => {
                    globalThis.location.href = '/login';
                }, 2000);
            } else {
                const error = await response.json();
                newPasswordInput.classList.add('flash-error');
                confirmPasswordInput.classList.add('flash-error');
                errorDiv.textContent = error.detail || 'An error occurred. Please try again.';
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            console.error('Password reset error:', error);
            newPasswordInput.classList.add('flash-error');
            confirmPasswordInput.classList.add('flash-error');
            errorDiv.textContent = 'Network error. Please try again.';
            errorDiv.style.display = 'block';
        }
    });
});
</script>
{% endblock %}
