<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content History - Nexus</title>
    <link rel="stylesheet" href="/static/css/main.css?v=202511210100">
    <link rel="stylesheet" href="/static/css/feed.css?v=202512060200">
    <style>
        /* Override main.css body margin for consistent layout */
        body {
            margin: 0;
            background: #f5f5f5;
        }

        .history-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .history-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .history-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .history-tab:hover {
            color: #007bff;
        }

        .history-tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .history-content {
            display: none;
        }

        .history-content.active {
            display: block;
        }

        .history-list {
            list-style: none;
            padding: 0;
        }

        .history-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s;
        }

        .history-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .history-item-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .history-item-link {
            color: #007bff;
            text-decoration: none;
        }

        .history-item-link:hover {
            text-decoration: underline;
        }

        .history-item-meta {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }

        .history-item-time {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .history-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .history-stats {
            font-size: 14px;
            color: #666;
        }

        .history-controls-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }

        .page-size-selector select {
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-clear-history {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-clear-history:hover {
            background: #c82333;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button:hover {
            background: #007bff;
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        body.dark-mode .history-item {
            background: #2a2a2a;
            border-color: #444;
        }

        body.dark-mode .history-item-title {
            color: #e0e0e0;
        }

        body.dark-mode .history-tabs {
            border-bottom-color: #444;
        }

        body.dark-mode .pagination button {
            background: #2a2a2a;
            border-color: #007bff;
        }

        body.dark-mode .pagination button:hover {
            background: #007bff;
        }

        body.dark-mode .page-size-selector {
            color: #ccc;
        }

        body.dark-mode .page-size-selector select {
            background: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        html.light-mode .page-size-selector select {
            background: white;
            border-color: #ccc;
            color: #333;
        }
    </style>

    <!-- Immediate mode initialization to prevent flash - MUST be before CSS -->
    <script>
        (function () {
            // Only apply light mode if explicitly selected (dark mode is default)
            const savedPreference = localStorage.getItem('darkMode');

            if (savedPreference === 'false') {
                // User explicitly selected light mode
                document.documentElement.classList.add('light-mode');
            }
            // No else needed - dark mode is default without any class
        })();
    </script>
    <style>
        /* Blocking inline styles to prevent flash - applied immediately */
        /* Set variables based on mode */
        html {
            --bg-primary: #181818;
            --bg-secondary: #222222;
            --bg-tertiary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #999999;
        }

        html.light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e0e0e0;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #999999;
        }

        /* Apply variables to elements */
        html,
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Explicit dark mode styles (default) */
        html:not(.light-mode),
        html:not(.light-mode) body {
            background-color: #181818;
            color: #ffffff;
        }

        /* Explicit light mode styles */
        html.light-mode,
        html.light-mode body {
            background-color: #ffffff;
            color: #333333;
        }
    </style>
</head>

<body>
    <header class="main-header">
        <div class="container">
            <h1>üöÄ Nexus - Content History</h1>
            <nav>
                <span id="user-welcome" class="user-welcome"></span>
                <button id="dark-mode-toggle" onclick="toggleDarkMode()" aria-label="Toggle dark mode">üåô</button>
                <span id="dark-mode-label" class="dark-mode-label">Dark Mode: Off</span>
                <a href="/">Feed</a>
                <a href="/history.html" class="active">History</a>
                <button id="auth-btn" onclick="handleAuth()">Login</button>
            </nav>
        </div>
    </header>

    <main>
        <div class="history-container">
            <div class="history-tabs">
                <button class="history-tab content-btn active" data-type="seen">Seen Content</button>
                <button class="history-tab content-btn" data-type="clicked">Clicked Content</button>
                <button class="history-tab content-btn" data-type="">All History</button>
            </div>

            <div id="seen-content" class="history-content active">
                <div class="history-controls">
                    <div class="history-controls-left">
                        <div class="history-stats" id="seen-stats">Loading...</div>
                        <div class="page-size-selector">
                            <label for="seen-page-size">Show:</label>
                            <select id="seen-page-size" onchange="changePageSize('seen', this.value)">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span>per page</span>
                        </div>
                    </div>
                    <button class="btn-clear-history" onclick="clearHistory('seen')">Clear Seen History</button>
                </div>
                <ul class="history-list" id="seen-list"></ul>
                <div class="pagination" id="seen-pagination"></div>
            </div>

            <div id="clicked-content" class="history-content">
                <div class="history-controls">
                    <div class="history-controls-left">
                        <div class="history-stats" id="clicked-stats">Loading...</div>
                        <div class="page-size-selector">
                            <label for="clicked-page-size">Show:</label>
                            <select id="clicked-page-size" onchange="changePageSize('clicked', this.value)">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span>per page</span>
                        </div>
                    </div>
                    <button class="btn-clear-history" onclick="clearHistory('clicked')">Clear Clicked History</button>
                </div>
                <ul class="history-list" id="clicked-list"></ul>
                <div class="pagination" id="clicked-pagination"></div>
            </div>

            <div id="all-content" class="history-content">
                <div class="history-controls">
                    <div class="history-controls-left">
                        <div class="history-stats" id="all-stats">Loading...</div>
                        <div class="page-size-selector">
                            <label for="all-page-size">Show:</label>
                            <select id="all-page-size" onchange="changePageSize('all', this.value)">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span>per page</span>
                        </div>
                    </div>
                    <button class="btn-clear-history" onclick="clearHistory(null)">Clear All History</button>
                </div>
                <ul class="history-list" id="all-list"></ul>
                <div class="pagination" id="all-pagination"></div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Nexus. Powered by Google Trends.</p>
    </footer>

    <!-- Shared Header Modules (loaded in order) -->
    <script src="/static/js/HeaderAuth.js?v=202512060200"></script>
    <script src="/static/js/HeaderDarkMode.js?v=202512060200"></script>
    <script src="/static/js/HeaderMenu.js?v=202512060200"></script>
    <script src="/static/js/HeaderPreferences.js?v=202512060200"></script>
    <script src="/static/js/HeaderSession.js?v=202512060200"></script>

    <script>
        let currentTab = 'seen';
        let currentPage = { seen: 1, clicked: 1, all: 1 };
        let pageSize = { seen: 10, clicked: 10, all: 10 }; // Default 10, resets on page reload

        // Tab switching
        document.querySelectorAll('.history-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.history-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.history-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                const type = tab.dataset.type;
                currentTab = type || 'all';

                const contentId = type === 'seen' ? 'seen-content' :
                    type === 'clicked' ? 'clicked-content' : 'all-content';
                document.getElementById(contentId).classList.add('active');

                loadHistory(currentTab, currentPage[currentTab]);
            });
        });

        // Change page size
        function changePageSize(type, newSize) {
            pageSize[type] = parseInt(newSize);
            currentPage[type] = 1; // Reset to first page when changing size
            loadHistory(type, 1);
        }

        // Load history
        async function loadHistory(type, page = 1) {
            const listId = type === 'all' ? 'all-list' : `${type}-list`;
            const statsId = type === 'all' ? 'all-stats' : `${type}-stats`;
            const paginationId = type === 'all' ? 'all-pagination' : `${type}-pagination`;

            const list = document.getElementById(listId);
            const stats = document.getElementById(statsId);
            const pagination = document.getElementById(paginationId);

            list.innerHTML = '<div class="loading">Loading history...</div>';

            try {
                let url = `/api/v1/history/viewed?page=${page}&page_size=${pageSize[type]}`;
                if (type !== 'all') {
                    url += `&view_type=${type}`;
                }

                const response = await fetch(url, { credentials: 'include' });

                if (!response.ok) {
                    throw new Error('Failed to load history');
                }

                const data = await response.json();

                // Update stats
                stats.textContent = `Total: ${data.total} items`;

                // Render items
                if (data.items.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>No ${type === 'all' ? '' : type} content in your history yet.</p>
                        </div>
                    `;
                } else {
                    list.innerHTML = data.items.map(item => `
                        <li class="history-item">
                            <div class="history-item-title">
                                <a href="/story/${item.content_slug}" class="history-item-link" target="_blank">
                                    ${item.title}
                                </a>
                            </div>
                            <div class="history-item-meta">
                                <span class="history-item-time">
                                    ${item.view_type === 'clicked' ? 'üñ±Ô∏è Clicked' : 'üëÅÔ∏è Viewed'} 
                                    ${formatTime(item.viewed_at)}
                                </span>
                                ${item.time_spent_seconds ? `
                                    <span>‚è±Ô∏è ${item.time_spent_seconds}s</span>
                                ` : ''}
                            </div>
                        </li>
                    `).join('');
                }

                // Render pagination
                renderPagination(pagination, data, type, page);

            } catch (error) {
                console.error('Error loading history:', error);
                list.innerHTML = '<div class="empty-state"><p>Error loading history. Please try again.</p></div>';
            }
        }

        function renderPagination(container, data, type, page) {
            if (data.total <= data.page_size) {
                container.innerHTML = '';
                return;
            }

            const totalPages = Math.ceil(data.total / data.page_size);

            container.innerHTML = `
                <button onclick="changePage('${type}', ${page - 1})" ${page === 1 ? 'disabled' : ''}>
                    ‚Üê Previous
                </button>
                <span>Page ${page} of ${totalPages}</span>
                <button onclick="changePage('${type}', ${page + 1})" ${!data.has_more ? 'disabled' : ''}>
                    Next ‚Üí
                </button>
            `;
        }

        function changePage(type, page) {
            currentPage[type] = page;
            loadHistory(type, page);
        }

        async function clearHistory(type) {
            const typeName = type === null ? 'all' : type;
            if (!confirm(`Are you sure you want to clear ${typeName} history? This cannot be undone.`)) {
                return;
            }

            try {
                let url = '/api/v1/history/clear';
                if (type) {
                    url += `?view_type=${type}`;
                }

                const response = await fetch(url, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('History cleared successfully!');
                    loadHistory(currentTab, 1);
                    currentPage[currentTab] = 1;
                } else {
                    throw new Error('Failed to clear history');
                }
            } catch (error) {
                console.error('Error clearing history:', error);
                alert('Failed to clear history. Please try again.');
            }
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;

            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;

            return date.toLocaleDateString();
        }

        // Load initial history
        loadHistory('seen', 1);
    </script>
</body>

</html>