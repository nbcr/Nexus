<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Nexus</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="stylesheet" href="/static/css/base.css?v=202512010100">
    <link rel="stylesheet" href="/static/css/header.css?v=202512010100">
    <link rel="stylesheet" href="/static/css/components.css?v=202512010100">
    <style>
        .settings-layout {
            display: flex;
            min-height: calc(100vh - 80px);
            background: var(--bg-primary);
            margin-top: 0;
        }
        .settings-sidebar {
            width: 220px;
            background: var(--bg-secondary);
            padding: 32px 0 0 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
            box-shadow: 2px 0 16px rgba(0,0,0,0.08);
        }
        .settings-sidebar .settings-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            margin: 18px 0;
            padding: 16px 0;
            width: 90%;
            border-radius: 12px;
            background: none;
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            text-decoration: none;
            border: none;
        }
        .settings-sidebar .settings-link:hover {
            background: var(--bg-tertiary);
            color: #007bff;
        }
        .settings-sidebar .settings-link.active {
            background: var(--bg-tertiary);
            color: #007bff;
        }
        .settings-content {
            flex: 1;
            padding: 48px 32px;
            color: var(--text-primary);
        }
        .settings-section {
            display: none;
        }
        .settings-section.active {
            display: block;
        }
        
        /* History Tabs */
        .history-tabs {
            display: flex;
            gap: 12px;
            margin: 24px 0;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--bg-tertiary);
        }
        .history-tab-btn {
            padding: 12px 24px;
            border: 1px solid var(--bg-tertiary);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .history-tab-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .history-tab-btn.active {
            background: var(--accent-light);
            color: #fff;
            border-color: var(--accent-light);
        }
        .history-content {
            margin: 24px 0;
            min-height: 300px;
        }
        .history-list {
            display: none;
        }
        .history-list.active {
            display: block;
        }
        .history-item {
            padding: 16px;
            margin-bottom: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 3px solid var(--accent-light);
        }
        .history-item-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .history-item-date {
            font-size: 14px;
            color: var(--text-secondary);
        }
        .btn {
            padding: 12px 24px;
            background: var(--accent-light);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.2s;
        }
        .btn:hover {
            background: var(--accent-hover);
        }
    </style>
    
    <!-- Immediate mode initialization to prevent flash - MUST be before CSS -->
    <script>
        (function() {
            // Only apply light mode if explicitly selected (dark mode is default)
            const savedPreference = localStorage.getItem('darkMode');
            
            if (savedPreference === 'false') {
                // User explicitly selected light mode
                document.documentElement.classList.add('light-mode');
            }
            // No else needed - dark mode is default without any class
        })();
    </script>
    <style>
        /* Blocking inline styles to prevent flash - applied immediately */
        /* Set variables based on mode */
        html {
            --bg-primary: #181818;
            --bg-secondary: #222222;
            --bg-tertiary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #999999;
        }
        
        html.light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e0e0e0;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #999999;
        }
        
        /* Apply variables to elements */
        html, body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        /* Explicit dark mode styles (default) */
        html:not(.light-mode),
        html:not(.light-mode) body {
            background-color: #181818;
            color: #ffffff;
        }
        
        /* Explicit light mode styles */
        html.light-mode,
        html.light-mode body {
            background-color: #ffffff;
            color: #333333;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <a href="/" class="header-title-link">
                <h1><img src="/static/favicon.png" alt="Nexus" class="site-logo"> Nexus - The Ai News Portal</h1>
            </a>
            <nav>
                <span id="user-welcome" class="user-welcome"></span>
                <button class="hamburger" id="hamburger-menu" aria-label="Open menu">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </button>
                <!-- Desktop auth buttons - visible in header -->
                <div class="header-auth-buttons" id="header-auth-buttons">
                    <a href="/login" id="auth-btn" class="header-btn"><span class="menu-icon">üîê</span><span class="menu-label">Login</span></a>
                    <a href="/register" id="register-btn" class="header-btn"><span class="menu-icon">üìù</span><span class="menu-label">Register</span></a>
                </div>
                <div class="nav-links" id="nav-links">
                    <a href="/" class="menu-quick"><span class="menu-icon">üè†</span><span class="menu-label">Feed</span></a>
                    <a href="/settings" class="menu-quick"><span class="menu-icon">‚öôÔ∏è</span><span class="menu-label">Settings</span></a>
                    <button id="dark-mode-toggle-menu"><span class="menu-icon">üåô</span><span class="menu-label">Dark Mode</span></button>
                    
                    <!-- Mobile auth buttons - appear in menu -->
                    <a href="/login" class="auth-btn-mobile" id="auth-btn-mobile"><span class="menu-icon">üîê</span><span class="menu-label">Login</span></a>
                    <a href="/register" class="auth-btn-mobile" id="register-btn-mobile"><span class="menu-icon">üìù</span><span class="menu-label">Register</span></a>
                    
                    <!-- Text size controls -->
                    <div class="text-size-controls">
                        <button id="text-size-decrease" class="text-size-btn" aria-label="Decrease text size">‚ûñ</button>
                        <span class="text-size-label">
                            <span class="text-size-line1">Text</span>
                            <span class="text-size-line2">Size</span>
                        </span>
                        <button id="text-size-increase" class="text-size-btn" aria-label="Increase text size">‚ûï</button>
                    </div>
                </div>
            </nav>
        </div>
    </header>
    
    <div class="settings-layout">
        <nav class="settings-sidebar">
            <button data-section="privacy" class="settings-link active"><span class="menu-icon">üîí</span>Privacy Policy</button>
            <button data-section="terms" class="settings-link"><span class="menu-icon">üìÑ</span>Terms of Service</button>
            <button data-section="history" class="settings-link"><span class="menu-icon">üìú</span>History</button>
            <button data-section="account" class="settings-link"><span class="menu-icon">üë§</span>Account</button>
            <button data-section="appearance" class="settings-link"><span class="menu-icon">üåó</span>Appearance</button>
        </nav>
        <main class="settings-content">
            <!-- Privacy Section -->
            <div id="privacy-section" class="settings-section active">
                <h2>Privacy Policy</h2>
                <p>Your privacy is important to us. This policy explains how we collect, use, and protect your personal information.</p>
                <h3>Data Collection</h3>
                <p>We collect information you provide directly to us, including your username, email, and browsing preferences.</p>
                <h3>Data Usage</h3>
                <p>We use your data to personalize your feed and improve our services.</p>
            </div>
            
            <!-- Terms Section -->
            <div id="terms-section" class="settings-section">
                <h2>Terms of Service</h2>
                <p>By using Nexus, you agree to these terms and conditions.</p>
                <h3>Acceptable Use</h3>
                <p>You agree to use our service responsibly and in accordance with all applicable laws.</p>
            </div>
            
            <!-- History Section -->
            <div id="history-section" class="settings-section">
                <h2>Browsing History</h2>
                <p>Your browsing history helps us personalize your feed.</p>
                
                <div class="history-tabs">
                    <button class="history-tab-btn active" data-history-type="seen">Seen</button>
                    <button class="history-tab-btn" data-history-type="clicked">Clicked</button>
                    <button class="history-tab-btn" data-history-type="read">Read</button>
                </div>
                
                <div class="history-content">
                    <div id="seen-history" class="history-list active"></div>
                    <div id="clicked-history" class="history-list"></div>
                    <div id="read-history" class="history-list"></div>
                </div>
                
                <button id="clear-history-btn" class="btn">Clear All History</button>
            </div>
            
            <!-- Account Section -->
            <div id="account-section" class="settings-section">
                <h2>Account Settings</h2>
                <p>Manage your account preferences here.</p>
                <h3>Profile Information</h3>
                <p id="account-info">Loading...</p>
                <button id="logout-btn" class="btn">Logout</button>
            </div>
            
            <!-- Appearance Section -->
            <div id="appearance-section" class="settings-section">
                <h2>Appearance</h2>
                <p>Customize how Nexus looks.</p>
                <h3>Theme</h3>
                <button id="toggle-dark-mode-btn" class="btn">Toggle Dark Mode</button>
                <h3>Text Size</h3>
                <p>Adjust text size using the controls in the menu.</p>
            </div>
        </main>
    </div>
    
    <script src="/static/js/header.js"></script>
    <script>
        // Settings page functionality
        document.addEventListener('DOMContentLoaded', function() {
            const settingsLinks = document.querySelectorAll('.settings-link');
            const sections = document.querySelectorAll('.settings-section');
            
            // Handle section switching
            settingsLinks.forEach(link => {
                link.addEventListener('click', function() {
                    const sectionName = this.dataset.section;
                    
                    // Update active link
                    settingsLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show selected section
                    sections.forEach(s => s.classList.remove('active'));
                    document.getElementById(`${sectionName}-section`).classList.add('active');
                });
            });
            
            // Clear history button
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', async function() {
                    if (!confirm('Are you sure you want to clear all your browsing history?')) {
                        return;
                    }
                    
                try {
                    const response = await fetch('/api/v1/history/clear', {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        alert('History cleared successfully');
                        // Reload history lists
                        loadHistory('seen');
                        loadHistory('clicked');
                        loadHistory('read');
                    } else {
                        alert('Failed to clear history');
                    }
                } catch (error) {
                    console.error('Error clearing history:', error);
                    alert('Error clearing history');
                }
                });
            }
            
            // History tabs
            const historyTabBtns = document.querySelectorAll('.history-tab-btn');
            const historyLists = document.querySelectorAll('.history-list');
            
            historyTabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const historyType = this.dataset.historyType;
                    
                    // Update active tab
                    historyTabBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show selected history list
                    historyLists.forEach(l => l.classList.remove('active'));
                    document.getElementById(`${historyType}-history`).classList.add('active');
                    
                    // Load history if not already loaded
                    const historyList = document.getElementById(`${historyType}-history`);
                    if (!historyList.dataset.loaded) {
                        loadHistory(historyType);
                    }
                });
            });
            
            // Load history function
            async function loadHistory(type) {
                const historyList = document.getElementById(`${type}-history`);
                historyList.innerHTML = '<p>Loading...</p>';
                
                try {
                    const response = await fetch(`/api/v1/history/viewed?view_type=${type}`, {
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.items.length === 0) {
                            historyList.innerHTML = '<p>No history found.</p>';
                        } else {
                            historyList.innerHTML = data.items.map(item => `
                                <div class="history-item">
                                    <div class="history-item-title">${item.title || 'Untitled'}</div>
                                    <div class="history-item-date">${new Date(item.viewed_at).toLocaleString()}</div>
                                </div>
                            `).join('');
                        }
                        
                        historyList.dataset.loaded = 'true';
                    } else {
                        historyList.innerHTML = '<p>Failed to load history. You may need to log in.</p>';
                    }
                } catch (error) {
                    console.error(`Error loading ${type} history:`, error);
                    historyList.innerHTML = '<p>Error loading history.</p>';
                }
            }
            
            // Load initial history (seen)
            loadHistory('seen');
            
            // Logout button
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    localStorage.removeItem('token');
                    document.cookie = 'access_token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                    window.location.href = '/login';
                });
            }
            
            // Toggle dark mode button
            const toggleDarkModeBtn = document.getElementById('toggle-dark-mode-btn');
            if (toggleDarkModeBtn) {
                toggleDarkModeBtn.addEventListener('click', function() {
                    document.documentElement.classList.toggle('light-mode');
                    const isLight = document.documentElement.classList.contains('light-mode');
                    localStorage.setItem('darkMode', !isLight);
                    this.textContent = isLight ? 'Switch to Dark Mode' : 'Switch to Light Mode';
                });
                
                // Update button text on load
                const isLight = document.documentElement.classList.contains('light-mode');
                toggleDarkModeBtn.textContent = isLight ? 'Switch to Dark Mode' : 'Switch to Light Mode';
            }
            
            // Load account info
            async function loadAccountInfo() {
                try {
                    const response = await fetch('/api/v1/auth/me', {
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('account-info').textContent = 
                            `Username: ${data.username}\nEmail: ${data.email || 'Not provided'}`;
                    } else {
                        document.getElementById('account-info').textContent = 'Not logged in';
                    }
                } catch (error) {
                    console.error('Error loading account info:', error);
                    document.getElementById('account-info').textContent = 'Error loading account info';
                }
            }
            
            loadAccountInfo();
        });
    </script>
</body>
</html>
